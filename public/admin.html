<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Pentadbir</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; }
        #map { height: 100vh; } /* Peta akan penuhi skrin */
        .header { background-color: #333; color: white; text-align: center; padding: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Dashboard Lokasi Petugas</h1>
        <p style="margin:0;">Lokasi dikemaskini secara automatik setiap 5 saat.</p>
    </div>
    <div id="map"></div>

    <script>
        // Inisialisasi peta - letakkan koordinat pusat majlis anda
        const map = L.map('map').setView([4.6296, 101.1420], 15); // Contoh: Pusat Tambun, Perak

        // Tambah lapisan peta dari OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let markers = {}; // Objek untuk menyimpan penanda (markers)

        // Fungsi untuk mendapatkan dan memaparkan lokasi
        async function fetchLocations() {
            try {
                const response = await fetch('http://localhost:3000/get-locations');
                const locations = await response.json();

                for (const name in locations) {
                    const staff = locations[name];
                    const popupContent = `<b>${name}</b><br>${staff.jawatan}<br>Dikemaskini: ${staff.lastUpdate}`;

                    if (staff.lat !== 0) { // Hanya tunjuk jika lokasi telah dikemaskini
                        if (markers[name]) {
                            // Kemaskini lokasi jika penanda sudah wujud
                            markers[name].setLatLng([staff.lat, staff.lon]).setPopupContent(popupContent);
                        } else {
                            // Cipta penanda baru jika belum wujud
                            markers[name] = L.marker([staff.lat, staff.lon]).addTo(map)
                                .bindPopup(popupContent);
                        }
                    }
                }
            } catch (error) {
                console.error('Gagal mendapatkan lokasi:', error);
            }
        }

        // Panggil fungsi setiap 5 saat
        fetchLocations(); // Panggil sekali pada mulanya
        setInterval(fetchLocations, 5000);
    </script>
</body>
</html>